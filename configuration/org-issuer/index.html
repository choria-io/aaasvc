<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.98.0"><meta name=generator content="Relearn 5.7.0"><meta name=description content><meta name=author content="Choria Project"><title>Org Issuer Based :: Choria AAA Service</title><link href=https://choria-io.github.io/aaasvc/configuration/org-issuer/index.xml rel=alternate type=application/rss+xml title="Org Issuer Based :: Choria AAA Service"><link href=https://choria-io.github.io/aaasvc/css/fontawesome-all.min.css?1669912324 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://choria-io.github.io/aaasvc/css/fontawesome-all.min.css?1669912324 rel=stylesheet></noscript><link href=https://choria-io.github.io/aaasvc/css/featherlight.min.css?1669912324 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://choria-io.github.io/aaasvc/css/featherlight.min.css?1669912324 rel=stylesheet></noscript><link href=https://choria-io.github.io/aaasvc/css/auto-complete.css?1669912324 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://choria-io.github.io/aaasvc/css/auto-complete.css?1669912324 rel=stylesheet></noscript><link href=https://choria-io.github.io/aaasvc/css/perfect-scrollbar.min.css?1669912324 rel=stylesheet><link href=https://choria-io.github.io/aaasvc/css/nucleus.css?1669912324 rel=stylesheet><link href=https://choria-io.github.io/aaasvc/css/fonts.css?1669912324 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://choria-io.github.io/aaasvc/css/fonts.css?1669912324 rel=stylesheet></noscript><link href=https://choria-io.github.io/aaasvc/css/theme.css?1669912324 rel=stylesheet><link href=https://choria-io.github.io/aaasvc/css/theme-my-custom-variant.css?1669912324 rel=stylesheet id=variant-style><link href=https://choria-io.github.io/aaasvc/css/ie.css?1669912324 rel=stylesheet><link href=https://choria-io.github.io/aaasvc/css/variant.css?1669912324 rel=stylesheet><link href=https://choria-io.github.io/aaasvc/css/print.css?1669912324 rel=stylesheet media=print><script src=https://choria-io.github.io/aaasvc/js/url.js?1669912324></script>
<script src=https://choria-io.github.io/aaasvc/js/variant.js?1669912324></script>
<script>window.index_json_url="https://choria-io.github.io/aaasvc/index.json";var root_url="https://choria-io.github.io/aaasvc/",baseUriFull,baseUri=root_url.replace(/\/$/,'');window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found="No results found for \u0022{0}\u0022",window.T_N_results_found="{1} results found for \u0022{0}\u0022",baseUriFull="https://choria-io.github.io/aaasvc/",window.variants&&variants.init(["my-custom-variant"])</script><script src=https://choria-io.github.io/aaasvc/js/jquery.min.js?1669912324 defer></script></head><body class="mobile-support html disableInlineCopyToClipboard" data-url=https://choria-io.github.io/aaasvc/configuration/org-issuer/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable dir=ltr><div><div class=navigation><a class="nav nav-next" href=https://choria-io.github.io/aaasvc/configuration/userlist/index.html title="Userlist Authenticator (&#129106;)"><i class="fas fa-chevron-right fa-fw"></i></a></div><div class=navigation><a class="nav nav-prev" href=https://choria-io.github.io/aaasvc/configuration/ca/index.html title="CA Based (&#129104;)"><i class="fas fa-chevron-left fa-fw"></i></a></div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle title="Menu (CTRL+ALT+n)"><i class="fas fa-bars fa-fw"></i></a></span>
<span id=toc-menu title="Table of Contents (CTRL+ALT+t)"><i class="fas fa-list-alt fa-fw"></i></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=https://choria-io.github.io/aaasvc/index.html><span itemprop=name>Choria AAA Service</span></a><meta itemprop=position content="1">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=https://choria-io.github.io/aaasvc/configuration/index.html><span itemprop=name>Configuration</span></a><meta itemprop=position content="2">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Org Issuer Based</span><meta itemprop=position content="3"></li></ol></div><div class="default-animation progress"><div class=toc-wrapper dir=ltr><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#requirements>Requirements</a><ul><li><a href=#issuer-public-key>Issuer Public Key</a></li><li><a href=#authenticator-jwt>Authenticator JWT</a></li><li><a href=#request-signer-jwt>Request Signer JWT</a></li><li><a href=#rpc-service-jwt>RPC Service JWT</a></li></ul></li><li><a href=#general-service-configuration>General Service Configuration</a></li><li><a href=#authenticator>Authenticator</a></li><li><a href=#signer>Signer</a><ul><li><a href=#choria-configuration>Choria Configuration</a></li><li><a href=#signer-configuration>Signer Configuration</a></li></ul></li><li><a href=#authorizer>Authorizer</a><ul><li><a href=#action-list>Action List</a></li><li><a href=#open-policy-agent>Open Policy Agent</a></li></ul></li><li><a href=#auditing>Auditing</a><ul><li><a href=#logfile>Logfile</a></li><li><a href=#choria-streams>Choria Streams</a></li></ul></li><li><a href=#choria-broker-configuration>Choria Broker Configuration</a></li><li><a href=#choria-client-configuration>Choria Client Configuration</a><ul><li><a href=#choria-network-based-signatures>Choria Network Based Signatures</a></li></ul></li><li><a href=#choria-server-configuration>Choria Server Configuration</a></li><li><a href=#full-sample-configuration>Full Sample Configuration</a></li></ul></nav></div></div></div></nav><main id=body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><div id=head-tags></div><article class=default><h1 id=org-issuer-based>Org Issuer Based</h1><h2 id=overview>Overview</h2><p>This deployment method is suitable to users who do not have access to a Certificate Authority. You might be a Puppet user but do not want to use the Puppet CA for multiple purposes or, you deployed using a non-Puppet method and so do not have easy access to a natively supported CA.</p><p>This mode completely removes the need for per-user x509 certificates, the entire system is controlled by a series of JWT tokens and ed25519 keys. The resulting system is a hybrid system where authentication is handled by AAA Service but Signing is optional and something the AAA Service has full control over.</p><div class="box notices cstyle secondary"><div class=box-label><i class="fa-fw fas fa-code-branch"></i> Version Hint</div><div class=box-content><p>This applies only to Choria 0.27.0 and newer which is due to ship early 2023</p></div></div><p>The system is made up of a few components:</p><ol><li>An Authentication service, called the <strong>Authenticator</strong>, accessed over HTTP(S), can be run anywhere</li><li>A Signing service, called the <strong>Signer</strong>, accessed over Choria RPC, must run in the datacenter where fleets are</li><li>An Authorization service, called the <strong>Authorizer</strong>, called by the Signer and ran in the same process</li><li>Optional audit logging, called <strong>Auditors</strong>, called by the Authorizers and ran in the same process</li></ol><h2 id=requirements>Requirements</h2><p>You must already have a Choria Organization Issuer, essentially a ed25519 key-pair, and you need access to issue new tokens using the Issuer.</p><p>The Organization Issuer can be made using <code>choria jwt keys</code> or using Hashicorp Vault Transit Secrets Engine.</p><h3 id=issuer-public-key>Issuer Public Key</h3><p>Obtain your Organization Issuer public key, for the purpose of this documentation we will use <code>514969e316eb4a7146b8066feb6af5dbc05da0965ec57c9d3a7d3299d5d98fec</code>.</p><p>We&rsquo;ll assume the Issuer seed is in <code>choria-issuer.seed</code>.</p><div class="box notices cstyle secondary"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Using with Hashicorp Vault</div><div class=box-content><p>If you are using Vault with the Transit Secrets Engine to store your Organization Issuer set the <code>VAULT_ADDR</code> and <code>VAULT_TOKEN</code> environment variables and add <code>--vault</code> to <code>choria jwt</code> commands that need the issuer. Use the key name instead of <code>choria-issuer.seed</code> in the examples.</p></div></div><h3 id=authenticator-jwt>Authenticator JWT</h3><p>You need to have a Choria Client JWT that is signed by the Organization Issuer and is a valid Chain Issuer.</p><p>First we create the ed25519 key pair that is unique to the Authenticator:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ choria jwt keys /etc/aaasvc/authenticator.seed /etc/aaasvc/authenticator.public
Public Key: d19ebddf1e3b41233e776c64c5dfe54861d868101c0ec27105ccead00234abef
</code></pre><p>Now create the JWT, signed by the Issuer:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ choria jwt client /etc/aaasvc/authenticator.jwt aaa_chain_delegator choria-issuer.seed \
     --public-key $(cat /etc/aaasvc/authenticator.public) \
     --issuer \               # It can issue clients
     --no-fleet-management \  # It can not access any fleet nodes over RPC
     --validity 365d          # It will expire after 1 year
</code></pre><h3 id=request-signer-jwt>Request Signer JWT</h3><p>You need to have a Choria Client JWT that will be used to sign requests on behalf of other users.</p><p>First we create the ed25519 key pair that is unique to the Signer:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ choria jwt keys /etc/aaasvc/signer.seed /etc/aaasvc/signer.public
Public Key: 7b692d69af281772d7bf98e228451974776b4208608c4a17bb6eebf335ef5142
</code></pre><p>Now create the JWT, signed by the Issuer:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ choria jwt client /etc/aaasvc/signer.jwt aaa_request_signer choria-issuer.seed \
     --public-key $(cat /etc/aaasvc/signer.public) \
     --no-fleet-management \  # It can not access any fleet nodes over RPC
     --auth-delegation \      # It can sign requests on behalf of others
     --validity 365d          # It will expire after 1 year
</code></pre><h3 id=rpc-service-jwt>RPC Service JWT</h3><p>You need to have a Choria Server JWT that will be used by the RPC Service that signs requests for other users.</p><p>First we create the ed25519 key pair that is unique to the Signer Service:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ choria jwt keys /etc/aaasvc/signer-rpc.seed /etc/aaasvc/signer-rpc.public
Public Key: d3e0cdf8afc4b827953b3a0c3b01cf80618756d150d1d1e1f70017483a9b4cef
</code></pre><p>Now create the JWT, signed by the Issuer, replace <code>aaa.example.net</code> with an appropriately descriptive name for your environment, like the FQDN hosting the service:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ choria jwt server /etc/aaasvc/signer-rpc.jwt aaa.example.net $(cat /etc/aaasvc/signer-rpc.public) choria-issuer.seed
     --org choria \           # Must be `choria` for now
     --collectives choria \   # Add any other sub collectives you might have
     --service                # It&#39;s allowed to host Choria Services on the network
</code></pre><h2 id=general-service-configuration>General Service Configuration</h2><p>The AAA Service is configured using a JSON file, here is a basic one showing common parts, the following documentation sections will add to this starter JSON file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;logfile&#34;</span>: <span style=color:#e6db74>&#34;/var/log/aaasvc.log&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;loglevel&#34;</span>: <span style=color:#e6db74>&#34;warn&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;site&#34;</span>: <span style=color:#e6db74>&#34;london&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><table><thead><tr><th>Item</th><th>Description</th></tr></thead><tbody><tr><td><code>logfile</code></td><td>A file to log to, this is the standard location which will be covered by the included logrotation configuration</td></tr><tr><td><code>loglevel</code></td><td>The logging level, one of <code>debug</code>, <code>info</code>, <code>warn</code>, <code>error</code> or <code>fatal</code></td></tr><tr><td><code>site</code></td><td>A site name to expose in statistics, logs, audits etc, typically a DC name or some unique location identifier</td></tr></tbody></table><h2 id=authenticator>Authenticator</h2><p>Users log into Choria using <code>choria login</code> which communicates with the Authenticator service. We have one Authenticator today called <a href=../userlist>userlist</a> with its own documentation section.</p><p>Configuration only requires the private key for signing tokens:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;logfile&#34;</span>: <span style=color:#e6db74>&#34;/var/log/aaasvc.log&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;loglevel&#34;</span>: <span style=color:#e6db74>&#34;warn&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;site&#34;</span>: <span style=color:#e6db74>&#34;london&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#e6db74>&#34;443&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;tls_certificate&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/ssl/https.pem&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;tls_key&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/ssl/https.key&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;tls_ca&#34;</span>:  <span style=color:#e6db74>&#34;/etc/aaasvc/ssl/https-ca.pem&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;authenticator&#34;</span>: <span style=color:#e6db74>&#34;userlist&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;userlist_authenticator&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;validity&#34;</span>: <span style=color:#e6db74>&#34;1h&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;signing_key&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/authenticator.seed&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;signing_token&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/authenticator.public&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;users&#34;</span>: [],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;users_file&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Here we set the additional key <code>signing_token</code>.</p><h2 id=signer>Signer</h2><p>The Signer listens on the Choria RPC network for RPC clients wishing to have their requests signed, signs them and sends the signed request back.</p><p>The service is scalable horizontally or vertically, you can simply run many instances at the same time, there is no shared state between them or any kind of leader election, it&rsquo;s all Active-Active and adding more instances adds more capacity.</p><h3 id=choria-configuration>Choria Configuration</h3><p>Because the signer connects to Choria it needs a configuration file. Store this in <code>/etc/aaasvc/choria.conf</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>plugin.security.provider</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>choria</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugin.security.choria.seed_file</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/etc/aaasvc/signer-rpc.seed</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugin.security.choria.token_file</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/etc/aaasvc/signer-rpc.jwt</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugin.choria.middleware_hosts</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>choria.example.net:4222</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>identity</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>aaa.example.net</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>logfile</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/var/log/choria/choria-aaa.example.net.log</span>
</span></span></code></pre></div><h3 id=signer-configuration>Signer Configuration</h3><p>The configuration of the signer has a few relevant items, here&rsquo;s a full configuration for this scenario:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;choria_config&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/choria.conf&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;logfile&#34;</span>: <span style=color:#e6db74>&#34;/var/log/aaasvc.log&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;loglevel&#34;</span>: <span style=color:#e6db74>&#34;warn&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;site&#34;</span>: <span style=color:#e6db74>&#34;london&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;signer&#34;</span>: <span style=color:#e6db74>&#34;basicjwt&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;basicjwt_signer&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;signing_certificate&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/authenticator.public&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;signing_token&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/signer.jwt&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;signing_seed&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/signer.seed&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;max_validity&#34;</span>:<span style=color:#e6db74>&#34;1h&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;choria_service&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><table><thead><tr><th>Property</th><th>Description</th></tr></thead><tbody><tr><td><code>signing_certificate</code></td><td>The public key for your Authenticator. Incoming signing requests will have their JWTs verified using this, only ones signed by it will be allowed</td></tr><tr><td><code>signing_token</code></td><td>The token used to sign user requests</td></tr><tr><td><code>signing_seed</code></td><td>The token used to sign user requests</td></tr><tr><td><code>max_validity</code></td><td>Enforces the maximum validity period on any JWT we accept. The only exception is for tokens with the <code>service</code> claim set to true</td></tr><tr><td><code>choria_service</code></td><td>Instructs the Signer to connect to Choria and start a service, otherwise HTTPS must be used to sign requests, strongly recommend to use this method</td></tr></tbody></table><h2 id=authorizer>Authorizer</h2><p>There are 2 Authorizers and a given signer server can run only one.</p><h3 id=action-list>Action List</h3><p>The Action List Authorizer reads the <code>acls</code> claim from the users JWT and evaluate the request being signed against the list of allowed actions.</p><table><thead><tr><th>ACL</th><th>Description</th></tr></thead><tbody><tr><td><code>["puppet.status", "puppet.enable"]</code></td><td>User can access just these 2 actions and no others</td></tr><tr><td><code>["puppet.*", "rpcutil.ping"]</code></td><td>User can access all actions under the <code>puppet</code> agent and one under the <code>rpcutil</code> agent</td></tr><tr><td><code>["*"]</code></td><td>User can perform all actions on all agents</td></tr></tbody></table><p>Configuration is easy, it has no specific configuration.:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;logfile&#34;</span>: <span style=color:#e6db74>&#34;/var/log/aaasvc.log&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;loglevel&#34;</span>: <span style=color:#e6db74>&#34;warn&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;site&#34;</span>: <span style=color:#e6db74>&#34;london&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;authorizer&#34;</span>: <span style=color:#e6db74>&#34;actionlist&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=open-policy-agent>Open Policy Agent</h3><p>Requests can be authorized using <a href=https://www.openpolicyagent.org/>Open Policy Agent</a>, it&rsquo;s a large topic and has it&rsquo;s own <a href=../opa/>documentation section</a>.</p><h2 id=auditing>Auditing</h2><p>Auditors will write a log of every Authorization decision to their configured destination, multiple auditors can be active at a time.</p><h3 id=logfile>Logfile</h3><p>This is a simple auditor that just writes a logfile of the actions taken.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;logfile&#34;</span>: <span style=color:#e6db74>&#34;/var/log/aaasvc.log&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;loglevel&#34;</span>: <span style=color:#e6db74>&#34;warn&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;site&#34;</span>: <span style=color:#e6db74>&#34;london&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;auditors&#34;</span>: [<span style=color:#e6db74>&#34;logfile&#34;</span>],
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;logfile_auditor&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;logfile&#34;</span>: <span style=color:#e6db74>&#34;/var/log/signer_audit.json&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You have to arrange for rotation of this log file, each line will be a JSON line.</p><h3 id=choria-streams>Choria Streams</h3><p>If you want to aggregate audit logs from your regional signers back to the central authentication service this is the auditor to use.</p><p>It publishes structured messages to a Choria Streams topic that you can use the <a href=https://github.com/choria-io/stream-replicator>Choria Stream Replicator</a> to transport these from your regional DC to central for consumption.</p><p>Published messages will match the <a href=https://choria.io/schemas/choria/signer/v1/signature_audit.json>io.choria.signer.v1.signature_audit</a> JSON Schema.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;logfile&#34;</span>: <span style=color:#e6db74>&#34;/var/log/aaasvc.log&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;loglevel&#34;</span>: <span style=color:#e6db74>&#34;warn&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;site&#34;</span>: <span style=color:#e6db74>&#34;london&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;auditors&#34;</span>: [<span style=color:#e6db74>&#34;jetstream&#34;</span>],
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;jetstream_auditor&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;cluster_id&#34;</span>: <span style=color:#e6db74>&#34;test-cluster&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;servers&#34;</span>: <span style=color:#e6db74>&#34;nats://localhost:4222&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;topic&#34;</span>: <span style=color:#e6db74>&#34;audit&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=choria-broker-configuration>Choria Broker Configuration</h2><p>The Broker will verify connections are signed by anyone the Organization Issuer signed</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>plugin.security.issuer.names</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>choria</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugin.security.issuer.choria.public</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>514969e316eb4a7146b8066feb6af5dbc05da0965ec57c9d3a7d3299d5d98fec</span>
</span></span></code></pre></div><h2 id=choria-client-configuration>Choria Client Configuration</h2><p>Clients must know to login and requests signing be done, the <code>client.conf</code> settings enable that:</p><h3 id=choria-network-based-signatures>Choria Network Based Signatures</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>plugin.security.provider</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>choria</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugin.security.choria.token_file</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>~/.choria/client.jwt</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugin.security.choria.seed_file</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>~/.choria/client.key</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugin.choria.security.request_signer.service</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugin.login.aaasvc.login.url</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>https://caaa.example.net/choria/v1/login</span>
</span></span></code></pre></div><h2 id=choria-server-configuration>Choria Server Configuration</h2><p>The Server will verify requests are signed by anyone the Organization Issuer signed</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>plugin.security.issuer.names</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>choria</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugin.security.issuer.choria.public</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>514969e316eb4a7146b8066feb6af5dbc05da0965ec57c9d3a7d3299d5d98fec</span>
</span></span></code></pre></div><h2 id=full-sample-configuration>Full Sample Configuration</h2><p>Here is a sample configuration with:</p><ul><li>Authenticator on port 433 with external users</li><li>Signer listening as a service</li><li>Open Policy Agent Authorizer</li><li>Logfile auditing</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;logfile&#34;</span>: <span style=color:#e6db74>&#34;/var/log/aaasvc.log&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;loglevel&#34;</span>: <span style=color:#e6db74>&#34;warn&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;site&#34;</span>: <span style=color:#e6db74>&#34;london&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#e6db74>&#34;443&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;tls_certificate&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/ssl/https.pem&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;tls_key&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/ssl/https.key&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;tls_ca&#34;</span>:  <span style=color:#e6db74>&#34;/etc/aaasvc/ssl/https-ca.pem&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;authenticator&#34;</span>: <span style=color:#e6db74>&#34;userlist&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;authorizer&#34;</span>: <span style=color:#e6db74>&#34;opa&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;auditors&#34;</span>: [<span style=color:#e6db74>&#34;logfile&#34;</span>],
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;signer&#34;</span>: <span style=color:#e6db74>&#34;basicjwt&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;basicjwt_signer&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;signing_certificate&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/authenticator.public&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;signing_token&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/signer.jwt&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;signing_seed&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/signer.seed&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;max_validity&#34;</span>:<span style=color:#e6db74>&#34;1h&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;choria_service&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;logfile_auditor&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;logfile&#34;</span>: <span style=color:#e6db74>&#34;/var/log/signer_audit.json&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;userlist_authenticator&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;validity&#34;</span>: <span style=color:#e6db74>&#34;1h&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;signing_key&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/authenticator.seed&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;signing_token&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/authenticator.public&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;users_file&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/users.json&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><footer class=footline></footer></article></div></main></div><aside id=sidebar class=default-animation dir=ltr><div id=header-wrapper class=default-animation><div id=header class=default-animation><img src=https://choria-io.github.io/aaasvc/logo.png></div><div class="searchbox default-animation"><i class="fas fa-search" title="Search (CTRL+ALT+f)"></i>
<label class=a11y-only for=search-by>Search</label>
<input data-search-input id=search-by name=search-by class=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script>var contentLangs=["en"]</script><script src=https://choria-io.github.io/aaasvc/js/auto-complete.js?1669912324 defer></script>
<script src=https://choria-io.github.io/aaasvc/js/lunr.min.js?1669912324 defer></script>
<script src=https://choria-io.github.io/aaasvc/js/lunr.stemmer.support.min.js?1669912324 defer></script>
<script src=https://choria-io.github.io/aaasvc/js/lunr.multi.min.js?1669912324 defer></script>
<script src=https://choria-io.github.io/aaasvc/js/lunr.en.min.js?1669912324 defer></script>
<script src=https://choria-io.github.io/aaasvc/js/search.js?1669912324 defer></script></div><div id=homelinks class=default-animation><ul><li><a class=padding href=https://choria-io.github.io/aaasvc/index.html><i class="fas fa-home"></i> Home</a></li></ul></div><div id=content-wrapper class=highlightable><ul class=topics><li data-nav-id=/installtion/index.html class=dd-item><a href=https://choria-io.github.io/aaasvc/installtion/index.html><b>1. </b>Installation</a></li><li data-nav-id=/configuration/index.html class="dd-item parent alwaysopen"><a href=https://choria-io.github.io/aaasvc/configuration/index.html><b>2. </b>Configuration</a><ul id=subsections-632bb56b075027697eb90eb7e3d29a12><li data-nav-id=/configuration/ca/index.html class=dd-item><a href=https://choria-io.github.io/aaasvc/configuration/ca/index.html><b>2.1. </b>CA Based</a></li><li data-nav-id=/configuration/org-issuer/index.html class="dd-item active"><a href=https://choria-io.github.io/aaasvc/configuration/org-issuer/index.html><b>2.2. </b>Org Issuer Based</a></li><li data-nav-id=/configuration/userlist/index.html class=dd-item><a href=https://choria-io.github.io/aaasvc/configuration/userlist/index.html><b>2.3. </b>Userlist Authenticator</a></li><li data-nav-id=/configuration/opa/index.html class=dd-item><a href=https://choria-io.github.io/aaasvc/configuration/opa/index.html><b>2.4. </b>OPA Authorizer</a></li></ul></li><li data-nav-id=/monitoring/index.html class=dd-item><a href=https://choria-io.github.io/aaasvc/monitoring/index.html><b>3. </b>Monitoring</a></li></ul><div id=shortcuts><div class=nav-title>More</div><ul><li><a class=padding href=https://github.com/choria-io/aaasvc><i class="fab fa-fw fa-github"></i> GitHub</a></li><li><a class=padding href=https://github.com/choria-io/aaasvc/releases><i class="far fa-save"></i> Download</a></li><li><a class=padding href=https://github.com/choria-io/general/discussions><i class="far fa-comments"></i> Discussions</a></li><li><a class=padding href=https://github.com/choria-io/aaasvc/issues><i class="far fa-life-ring"></i> Issues</a></li><li><a class=padding href=https://slack.puppet.com/><i class="fab fa-slack"></i> #choria</a></li></ul></div><div class="footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"></div><hr class="default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"><div id=prefooter class="footerLangSwitch footerVariantSwitch footerVisitedLinks"><ul><li id=select-language-container class=footerLangSwitch><div class="padding select-container"><i class="fas fa-language fa-fw"></i>
<span>&nbsp;</span><div class=select-style><label class=a11y-only for=select-language>Language</label>
<select id=select-language onchange="location=baseUri+this.value"></select></div><div class=select-clear></div></div></li><li id=select-variant-container class=footerVariantSwitch><div class="padding select-container"><i class="fas fa-paint-brush fa-fw"></i>
<span>&nbsp;</span><div class=select-style><label class=a11y-only for=select-variant>Theme</label>
<select id=select-variant onchange=window.variants&&variants.changeVariant(this.value)><option id=my-custom-variant value=my-custom-variant selected>My Custom Variant</option></select></div><div class=select-clear></div></div><script>window.variants&&variants.markSelectedVariant()</script></li><li class=footerVisitedLinks><button class=padding onclick=clearHistory()><i class="fas fa-history fa-fw"></i> Clear History</button></li></ul></div><div id=footer class="footerFooter showFooter"><p>Built with <a href=https://github.com/McShelby/hugo-theme-relearn title=love><i class="fas fa-heart"></i></a> by <a href=https://gohugo.io/>Hugo</a></p></div></div></aside><script src=https://choria-io.github.io/aaasvc/js/clipboard.min.js?1669912324 defer></script>
<script src=https://choria-io.github.io/aaasvc/js/perfect-scrollbar.min.js?1669912324 defer></script>
<script src=https://choria-io.github.io/aaasvc/js/featherlight.min.js?1669912324 defer></script>
<script src=https://choria-io.github.io/aaasvc/js/theme.js?1669912324 defer></script></body></html>